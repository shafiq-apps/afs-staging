<script>
  (function() {
    const config = {
      apiBaseUrl: {{ block.settings.api_base_url | json }},
      shop: {{ shop.permanent_domain | json }},
      container: '#afs-container-{{ block.id }}',
      filtersContainer: '.afs-filters-container',
      productsContainer: '.afs-products-container',
      pageSize: 20,
      enableLogging: {{ block.settings.enable_logging | default: false }},
      collections: [
        {% for c in collections %}
          {
            id: {{ c.id | json }},
            title: {{ c.title | json }}
          }{% unless forloop.last %},{% endunless %}
        {% endfor %}
      ],
      selectedCollection: {
        id: {{ collection.id | json }},
        sortBy : {{ collection.default_sort_by  | json }}
      }
    };

    // Function to initialize AFS
    function initializeAFS() {
      if (typeof window.AFS !== 'undefined') {
        try {
          window.AFS.init(config);
        } catch (error) {
          console.error('Failed to initialize Advanced Filter Search:', error);
        }
      } else {
        setTimeout(initializeAFS, 100);
      }
    }

    // Wait for both DOM and script to be ready
    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', function() {
        // Wait a bit for the deferred script to load
        setTimeout(initializeAFS, 50);
      });
    } else {
      // DOM is already ready, just wait for script
      setTimeout(initializeAFS, 50);
    }
  })();
</script>