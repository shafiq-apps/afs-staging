{% assign page_size = block.settings.page_size | default: 24 %}
{% assign liquid_current_page = 1 %}
{% assign liquid_total_pages = 1 %}
{% assign liquid_total_products = 0 %}

<script>
  (function() {
    // Extract products from Liquid collection as fallback
    const liquidProducts = [
      {% if collection.products %}
        {% comment %} 
          Shopify's paginate tag automatically reads ?page=X from URL
          The collection will be sorted based on collection.default_sort_by or URL sort_by parameter
        {% endcomment %}
        {% paginate collection.products by page_size %}
          {% assign liquid_current_page = paginate.current_page %}
          {% assign liquid_total_pages = paginate.pages %}
          {% assign liquid_total_products = paginate.items %}
          {% for product in collection.products %}
            {
              id: {{ product.id | json }},
              gid: {{ product.id | json }},
              title: {{ product.title | json }},
              vendor: {{ product.vendor | json }},
              handle: {{ product.handle | json }},
              url: {{ product.url | json }},
              imageUrl: {% if product.featured_image %}{{ product.featured_image | image_url: width: 500 | json }}{% else %}''{% endif %},
              featuredImage: {% if product.featured_image %}{
                url: {{ product.featured_image | image_url: width: 500 | json }},
                alt: {{ product.featured_image.alt | json }}
              }{% else %}null{% endif %},
              priceRange: {
                minVariantPrice: {
                  amount: {{ product.price_min | divided_by: 100.0 | json }},
                  currencyCode: {{ cart.currency.iso_code | default: shop.currency | json }}
                },
                maxVariantPrice: {
                  amount: {{ product.price_max | divided_by: 100.0 | json }},
                  currencyCode: {{ cart.currency.iso_code | default: shop.currency | json }}
                }
              }
            }{% unless forloop.last %},{% endunless %}
          {% endfor %}
        {% endpaginate %}
      {% endif %}
    ];
    
    const liquidPagination = {
      currentPage: {{ liquid_current_page | json }},
      totalPages: {{ liquid_total_pages | json }},
      totalProducts: {{ liquid_total_products | json }}
    };

    const config = {
      apiBaseUrl: {{ block.settings.api_base_url | json }},
      shop: {{ shop.permanent_domain | json }},
      container: '#afs-container-{{ block.id }}',
      filtersContainer: '.afs-filters-container',
      productsContainer: '.afs-products-container',
      pageSize: {{ page_size | json }},
      enableLogging: {{ block.settings.enable_logging | default: false }},
      collections: [
        {% for c in collections %}
          {
            id: {{ c.id | json }},
            title: {{ c.title | json }}
          }{% unless forloop.last %},{% endunless %}
        {% endfor %}
      ],
      selectedCollection: {
        id: {{ collection.id | json }},
        sortBy : {{ collection.default_sort_by  | json }}
      },
      fallbackProducts: liquidProducts,
      fallbackPagination: liquidPagination
    };

    // Function to initialize AFS
    function initializeAFS() {
      if (typeof window.AFS !== 'undefined') {
        try {
          window.AFS.init(config);
        } catch (error) {
          console.error('Failed to initialize Advanced Filter Search:', error);
        }
      } else {
        setTimeout(initializeAFS, 100);
      }
    }

    // Wait for both DOM and script to be ready
    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', function() {
        // Wait a bit for the deferred script to load
        setTimeout(initializeAFS, 50);
      });
    } else {
      // DOM is already ready, just wait for script
      setTimeout(initializeAFS, 50);
    }
  })();
</script>