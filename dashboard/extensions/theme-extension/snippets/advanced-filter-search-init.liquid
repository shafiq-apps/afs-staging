{% comment %}
  Advanced Filter Search Initialization Snippet
  This snippet initializes AFS after all modules are loaded
  Block settings are passed via data attribute in the block Liquid file
{% endcomment %}

<script>
  (function() {
    'use strict';
    
    // Function to initialize AFS
    function initializeAFS() {
      // Check if all required modules are loaded
      if (!window.AFS || !window.AFS.AFS) {
        // Retry after a short delay if modules aren't loaded yet
        setTimeout(initializeAFS, 100);
        return;
      }
      
      // Find container for this block
      const container = document.querySelector('#afs-container-{{ block.id }}');
      if (!container) {
        console.warn('[AFS] Container not found for block {{ block.id }}');
        return;
      }
      
      // Get settings from data attribute or use defaults
      const blockData = container.getAttribute('data-afs-block-settings');
      let settings = {
        shop: '{{ shop.permanent_domain }}',
        container: '#afs-container-{{ block.id }}',
        filtersContainer: '{{ block.settings.filters_container_selector | default: ".afs-filters-container" }}',
        productsContainer: '{{ block.settings.products_container_selector | default: ".afs-products-container" }}',
        apiBaseUrl: '{{ block.settings.api_base_url | default: "https://fstaging.digitalcoo.com" }}'
      };
      
      // Override with data attribute if available
      if (blockData) {
        try {
          const parsed = JSON.parse(blockData);
          settings = { ...settings, ...parsed };
        } catch (e) {
          console.warn('[AFS] Failed to parse block settings', e);
        }
      }
      
      // Initialize AFS
      try {
        window.AFS.AFS.init(settings);
      } catch (error) {
        console.error('[AFS] Initialization failed', error);
      }
    }
    
    // Start initialization when DOM is ready
    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', initializeAFS);
    } else {
      // DOM already ready, wait a bit for deferred scripts
      setTimeout(initializeAFS, 50);
    }
  })();
</script>

