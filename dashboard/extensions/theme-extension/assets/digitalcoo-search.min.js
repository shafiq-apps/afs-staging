"use strict";

// src/utils/shared.ts
var Log = {
  enabled: true,
  // Always enabled for debugging
  error: (msg, data) => {
    if (Log.enabled) console.error("[AFS]", msg, data || "");
  },
  warn: (msg, data) => {
    if (Log.enabled) console.warn("[AFS]", msg, data || "");
  },
  info: (msg, data) => {
    if (Log.enabled) console.info("[AFS]", msg, data || "");
  },
  debug: (msg, data) => {
    if (Log.enabled) console.debug("[AFS]", msg, data || "");
  },
  log: (msg, ...args) => {
    if (Log.enabled) console.log(msg, ...args);
  },
  init: (enabled) => {
    Log.enabled = enabled !== false;
    Log.log(
      "%cAdvanced Filter & Search initialized",
      "color: #00c853;font-size: 20px;font-weight: bold;background: #0b1e13;padding: 10px 15px;border-radius: 6px;font-family: Arial, sans-serif;"
    );
  }
};

// src/locals/index.ts
var Lang = {
  buttons: {
    quickAdd: "Quick Add",
    quickAddToCart: "Quick add to cart",
    quickView: "Quick view",
    addToCart: "Add to cart",
    soldOut: "Sold out",
    buyNow: "Buy it now",
    clear: "Clear",
    clearAll: "Clear All",
    close: "\u2715",
    closeFilters: "Close filters",
    toggleFilters: "Filters",
    filters: "Filters",
    previous: "Previous",
    next: "Next",
    apply: "Apply"
  },
  labels: {
    sortBy: "Sort by: ",
    appliedFilters: "Applied Filters:",
    search: "Search: ",
    price: "Price: ",
    collection: "Collection: ",
    productUnavailable: "Product unavailable",
    loading: "Loading...",
    loadingProduct: "Loading product..."
  },
  sortOptions: {
    bestSelling: "Best Selling",
    titleAsc: "Title (A-Z)",
    titleDesc: "Title (Z-A)",
    priceAsc: "Price (Low to High)",
    priceDesc: "Price (High to Low)",
    createdAsc: "Oldest First",
    createdDesc: "Newest First"
  },
  messages: {
    noProductsFound: "No products found",
    oneProductFound: "1 product found",
    productsFound: "products found",
    showingProducts: "Showing",
    pageOf: "Page",
    addedToCart: "Added to cart!",
    failedToLoad: "Failed to load",
    failedToLoadProducts: "Failed to load products",
    failedToLoadProduct: "Failed to load product",
    failedToAddToCart: "Failed to add product to cart. Please try again.",
    failedToProceedToCheckout: "Failed to proceed to checkout. Please try again.",
    failedToLoadProductModal: "Failed to load product. Please try again.",
    failedToLoadFilters: "Failed to load filters, continuing with empty filters",
    initializationFailed: "Initialization failed",
    loadFailed: "Load failed",
    unknownError: "Unknown error",
    checkConsole: "Check console for details."
  },
  placeholders: {
    searchProducts: "Search products...",
    searchFilter: "Search"
  }
};

// src/utils/$.utils.ts
var $ = {
  // Fastest debounce
  debounce: (fn, ms) => {
    let t;
    return (...a) => {
      if (t !== void 0) clearTimeout(t);
      t = setTimeout(() => fn(...a), ms);
    };
  },
  toLowerCase: (s) => String(s || "").toLowerCase(),
  inputDisplayType: (option) => {
    return $.equalsAny($.toLowerCase(option == null ? void 0 : option.displayType), "radio" /* RADIO */) ? "radio" : "checkbox";
  },
  isMultiSelect: (option) => {
    return $.equalsAny($.toLowerCase(option == null ? void 0 : option.selectionType), "multiple" /* MULTIPLE */) || $.equalsAny(option == null ? void 0 : option.selectionType, "MULTIPLE" /* MULTIPLE_UPPER */);
  },
  // Fast array split
  split: (v) => {
    if (!v) return [];
    if (Array.isArray(v)) return v.map((s) => String(s).trim()).filter(Boolean);
    return String(v).split(",").map((s) => s.trim()).filter(Boolean);
  },
  // Fast ID getter
  id: (p) => {
    if (!p) return null;
    const id = p.productId || p.id || p.gid;
    if (!id) return null;
    return String(id).split("/").pop() || null;
  },
  // Fast string check
  str: (v) => String(v || "").trim(),
  // Fast empty check
  empty: (v) => {
    if (!v) return true;
    if (Array.isArray(v)) return v.length === 0;
    if (typeof v === "object") return Object.keys(v).length === 0;
    return false;
  },
  // Fast element creator
  el: (tag, cls, attrs = {}) => {
    const e = document.createElement(tag);
    if (cls) e.className = cls;
    Object.entries(attrs).forEach(([k, v]) => e.setAttribute(k, v));
    return e;
  },
  // Fast text setter
  txt: (el, text) => {
    el.textContent = text;
    return el;
  },
  // Fast clear (replaces innerHTML)
  clear: (el) => {
    while (el.firstChild) {
      const child = el.firstChild;
      if (child) el.removeChild(child);
    }
  },
  // Fast fragment append
  frag: (items, fn) => {
    const f = document.createDocumentFragment();
    items.forEach((item) => f.appendChild(fn(item)));
    return f;
  },
  // Optimize Shopify image URL with transformations
  optimizeImageUrl: (url, options = {}) => {
    if (!url || typeof url !== "string") return "";
    const {
      width = 500,
      height = width,
      quality = 80,
      format = "webp",
      crop = null
    } = options;
    const shopifyCdnPattern = /(cdn\.shopify\.com|shopifycdn\.com)/i;
    if (!shopifyCdnPattern.test(url)) return url;
    try {
      const urlObj = new URL(url);
      const params = new URLSearchParams(urlObj.search);
      params.delete("width");
      params.delete("height");
      params.delete("crop");
      params.delete("format");
      params.delete("quality");
      params.set("width", String(width));
      params.set("height", String(height));
      if (crop) params.set("crop", crop);
      if (quality !== 100) params.set("quality", String(quality));
      const isGif = urlObj.pathname.toLowerCase().endsWith(".gif");
      if (!isGif && format) params.set("format", format);
      return `${urlObj.origin}${urlObj.pathname}?${params.toString()}`;
    } catch (err) {
      return url;
    }
  },
  // Build responsive srcset for Shopify images
  buildImageSrcset: (baseUrl, sizes = [200, 300, 500]) => {
    if (!baseUrl) return "";
    return sizes.map((size) => {
      const optimized = $.optimizeImageUrl(baseUrl, { width: size, format: "webp", quality: size <= 200 ? 75 : size <= 300 ? 80 : 85 });
      return `${optimized} ${size}w`;
    }).join(", ");
  },
  // Format money using Shopify money format
  formatMoney: (cents, moneyFormat, currency = "") => {
    if (isNaN(Number(cents))) return "";
    const amount = parseFloat(String(cents)) / 100;
    if (!moneyFormat || typeof moneyFormat !== "string") {
      return `${currency || ""}${amount.toFixed(2)}`;
    }
    let formattedAmount = amount.toFixed(2);
    if (moneyFormat.includes("{{amount_no_decimals}}")) {
      formattedAmount = Math.round(amount).toString();
      return moneyFormat.replace("{{amount_no_decimals}}", formattedAmount);
    }
    if (moneyFormat.includes("{{amount_with_comma_separator}}")) {
      formattedAmount = amount.toFixed(2).replace(".", ",");
      return moneyFormat.replace("{{amount_with_comma_separator}}", formattedAmount);
    }
    if (moneyFormat.includes("{{amount_no_decimals_with_comma_separator}}")) {
      formattedAmount = Math.round(amount).toString();
      return moneyFormat.replace("{{amount_no_decimals_with_comma_separator}}", formattedAmount);
    }
    if (moneyFormat.includes("{{amount_with_apostrophe_separator}}")) {
      formattedAmount = amount.toFixed(2).replace(".", "'");
      return moneyFormat.replace("{{amount_with_apostrophe_separator}}", formattedAmount);
    }
    return moneyFormat.replace("{{amount}}", formattedAmount);
  },
  // Reusable comparison functions
  // Compare two values (string, number, boolean, array, or object) with case-insensitive and trimmed string comparison
  equals: (a, b) => {
    if (a === b) return true;
    if (a === null || a === void 0 || b === null || b === void 0) return false;
    if (Array.isArray(a)) {
      a = a.join(",");
    }
    if (Array.isArray(b)) {
      b = b.join(",");
    }
    if (typeof a === "string" && typeof b === "string") {
      return a.trim().toLowerCase() === b.trim().toLowerCase();
    }
    if (typeof a === "number" && typeof b === "number") {
      return a === b;
    }
    if (typeof a === "boolean" && typeof b === "boolean") {
      return a === b;
    }
    return String(a).trim().toLowerCase() === String(b).trim().toLowerCase();
  },
  // Check if value equals any of the provided enum/constant values (case-insensitive, trimmed)
  equalsAny: (value, ...values) => {
    if (value === null || value === void 0) return false;
    return values.some((v) => $.equals(value, v));
  },
  // Check if a filter key matches vendor (handles 'vendor' or 'vendors')
  isVendorKey: (key) => {
    return $.equalsAny(key, "vendor" /* VENDOR */, "vendors" /* VENDORS */);
  },
  // Check if a filter key matches productType (handles 'productType' or 'productTypes')
  isProductTypeKey: (key) => {
    return $.equalsAny(key, "productType" /* PRODUCT_TYPE */, "productTypes" /* PRODUCT_TYPES */);
  },
  // Check if a filter key matches tags (handles 'tag' or 'tags')
  isTagKey: (key) => {
    return $.equalsAny(key, "tag" /* TAG */, "tags" /* TAGS */);
  },
  // Check if a filter key matches collections (handles 'collection' or 'collections')
  isCollectionKey: (key) => {
    return $.equalsAny(key, "collection" /* COLLECTION */, "collections" /* COLLECTIONS */);
  },
  // Check if a filter key matches priceRange (handles 'priceRange' or 'price')
  isPriceRangeKey: (key) => {
    return $.equalsAny(key, "priceRange" /* PRICE_RANGE */, "price" /* PRICE */);
  },
  // Check if sort field is best-selling (handles 'best-selling' or 'bestselling')
  isBestSelling: (field) => {
    return $.equalsAny(field, "best-selling" /* BEST_SELLING */, "bestselling" /* BESTSELLING */);
  },
  // Check if option type is Collection
  isCollectionOptionType: (optionType) => {
    return $.equals(optionType, "Collection" /* COLLECTION */);
  },
  // Check if option type is priceRange
  isPriceRangeOptionType: (optionType) => {
    return $.equals(optionType, "priceRange" /* PRICE_RANGE */);
  }
};

// src/digitalcoo-search.ts
var DEFAULT_CONFIG = {
  apiBaseUrl: "https://fstaging.digitalcoo.com/storefront",
  shop: null,
  moneyFormat: null,
  currency: null,
  moneyWithCurrencyFormat: null,
  searchInputSelector: 'input[name="q"], input[name="search"], input[type="search"][name*="q"], input[type="search"][name*="search"], .search__input, form[action*="/search"] input[type="search"], form[action*="/search"] input[name*="q"]',
  minQueryLength: 2,
  debounceMs: 300,
  maxSuggestions: 5,
  maxProducts: 6,
  showSuggestions: true,
  showProducts: true,
  enableKeyboardNav: true
};
var SearchState = {
  config: DEFAULT_CONFIG,
  activeInput: null,
  dropdown: null,
  container: null,
  currentQuery: "",
  isOpen: false,
  selectedIndex: -1,
  searchResults: null,
  isLoading: false,
  abortController: null,
  replacedInputs: /* @__PURE__ */ new Set(),
  inputContainers: /* @__PURE__ */ new Map(),
  overriddenContainers: /* @__PURE__ */ new Set(),
  searchButtons: /* @__PURE__ */ new Set(),
  customSearchBox: null
};
var SearchDOM = {
  createContainer(input) {
    const container = $.el("div", "afs-search-container");
    container.style.position = "absolute";
    container.style.display = "block";
    const inputRect = input.getBoundingClientRect();
    const inputWidth = inputRect.width;
    const minWidth = 280;
    const containerWidth = inputWidth < minWidth ? minWidth : inputWidth;
    const scrollTop = window.pageYOffset || document.documentElement.scrollTop;
    const scrollLeft = window.pageXOffset || document.documentElement.scrollLeft;
    container.style.top = `${inputRect.bottom + scrollTop}px`;
    container.style.left = `${inputRect.left + scrollLeft}px`;
    container.style.width = `${containerWidth}px`;
    container.style.minWidth = `${minWidth}px`;
    container.style.zIndex = "999999";
    return container;
  },
  createDropdown() {
    const dropdown = $.el("div", "afs-search-dropdown");
    dropdown.setAttribute("role", "listbox");
    dropdown.setAttribute("aria-label", "Search results");
    return dropdown;
  },
  setupInputContainer(input) {
    if (SearchState.inputContainers.has(input)) {
      const existingContainer = SearchState.inputContainers.get(input);
      this.updateContainerPosition(input, existingContainer);
      return existingContainer;
    }
    const container = this.createContainer(input);
    document.body.appendChild(container);
    const dropdown = this.createDropdown();
    container.appendChild(dropdown);
    SearchState.inputContainers.set(input, container);
    const resizeObserver = new ResizeObserver(() => {
      this.updateContainerPosition(input, container);
      if (SearchState.isOpen && SearchState.activeInput === input) {
        this.positionDropdown(input);
      }
    });
    resizeObserver.observe(input);
    return container;
  },
  updateContainerPosition(input, container) {
    const inputRect = input.getBoundingClientRect();
    const inputWidth = inputRect.width;
    const minWidth = 280;
    const containerWidth = inputWidth < minWidth ? minWidth : inputWidth;
    const scrollTop = window.pageYOffset || document.documentElement.scrollTop;
    const scrollLeft = window.pageXOffset || document.documentElement.scrollLeft;
    container.style.top = `${inputRect.bottom + scrollTop}px`;
    container.style.left = `${inputRect.left + scrollLeft}px`;
    container.style.width = `${containerWidth}px`;
    container.style.minWidth = `${minWidth}px`;
  },
  createSuggestionItem(suggestion, index) {
    const item = $.el("div", "afs-search-dropdown__suggestion", {
      "role": "option",
      "data-index": String(index),
      "tabindex": "-1"
    });
    const icon = $.el("span", "afs-search-dropdown__suggestion-icon");
    icon.innerHTML = '<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="11" cy="11" r="8"/><path d="m21 21-4.35-4.35"/></svg>';
    const text = $.el("span", "afs-search-dropdown__suggestion-text");
    text.textContent = suggestion;
    item.appendChild(icon);
    item.appendChild(text);
    return item;
  },
  createProductItem(product, index) {
    var _a, _b;
    const handle = product.handle || "";
    const productUrl = handle ? `/products/${handle}` : "#";
    const item = $.el("a", "afs-search-dropdown__product", {
      "href": productUrl,
      "role": "option",
      "data-index": String(index),
      "data-handle": handle,
      "tabindex": "-1"
    });
    if (!handle) {
      item.addEventListener("click", (e) => {
        e.preventDefault();
        Log.warn("Product item clicked but no handle available", { product });
      });
    }
    if (product.imageUrl || product.featuredImage) {
      const imgContainer = $.el("div", "afs-search-dropdown__product-image");
      const img = $.el("img", "", {
        "alt": product.title || "",
        "loading": "lazy",
        "decoding": "async"
      });
      const baseImageUrl = ((_a = product.featuredImage) == null ? void 0 : _a.url) || ((_b = product.featuredImage) == null ? void 0 : _b.urlFallback) || product.imageUrl || "";
      if (baseImageUrl) {
        img.src = baseImageUrl;
      }
      imgContainer.appendChild(img);
      item.appendChild(imgContainer);
    }
    const info = $.el("div", "afs-search-dropdown__product-info");
    const title = $.el("div", "afs-search-dropdown__product-title");
    title.textContent = product.title || "";
    info.appendChild(title);
    if (product.vendor) {
      const vendor = $.el("div", "afs-search-dropdown__product-vendor");
      vendor.textContent = product.vendor;
      info.appendChild(vendor);
    }
    if (product.minPrice !== void 0) {
      const price = $.el("div", "afs-search-dropdown__product-price");
      const minPrice = parseFloat(String(product.minPrice || 0)) * 100;
      const maxPrice = parseFloat(String(product.maxPrice || 0)) * 100;
      const moneyFormat = SearchState.config.moneyFormat || "{{amount}}";
      const currency = SearchState.config.currency || "";
      const formattedMin = $.formatMoney(minPrice, moneyFormat, currency);
      const priceText = minPrice === maxPrice ? formattedMin : `from ${formattedMin}`;
      price.textContent = priceText;
      info.appendChild(price);
    }
    item.appendChild(info);
    return item;
  },
  createDidYouMeanItem(query) {
    const item = $.el("div", "afs-search-dropdown__did-you-mean", {
      "role": "option",
      "data-type": "did-you-mean",
      "tabindex": "-1"
    });
    const text = $.el("span", "afs-search-dropdown__did-you-mean-text");
    text.innerHTML = `Did you mean <strong>${query}</strong>?`;
    item.appendChild(text);
    return item;
  },
  createEmptyState(message) {
    const item = $.el("div", "afs-search-dropdown__empty", {
      "role": "option"
    });
    item.textContent = message;
    return item;
  },
  createLoadingState() {
    const item = $.el("div", "afs-search-dropdown__loading", {
      "role": "option"
    });
    item.innerHTML = `
			<div class="afs-search-dropdown__loading-spinner"></div>
			<span>${Lang.labels.loading}</span>
		`;
    return item;
  },
  renderDropdown(results, query, showEmptyState = false) {
    var _a;
    if (!SearchState.dropdown) return;
    SearchState.dropdown.innerHTML = "";
    SearchState.selectedIndex = -1;
    if (SearchState.isLoading) {
      SearchState.dropdown.appendChild(this.createLoadingState());
      return;
    }
    if (!query && showEmptyState) {
      const emptyState = this.createEmptyState("Start typing to search...");
      SearchState.dropdown.appendChild(emptyState);
      return;
    }
    if (!results) {
      return;
    }
    const fragment = document.createDocumentFragment();
    let itemIndex = 0;
    if (results.didYouMean && results.zeroResults) {
      const didYouMeanItem = this.createDidYouMeanItem(results.didYouMean);
      didYouMeanItem.setAttribute("data-index", String(itemIndex));
      fragment.appendChild(didYouMeanItem);
      itemIndex++;
    }
    if (SearchState.config.showSuggestions && results.suggestions && results.suggestions.length > 0) {
      const suggestionsHeader = $.el("div", "afs-search-dropdown__header");
      suggestionsHeader.textContent = "Suggestions";
      fragment.appendChild(suggestionsHeader);
      results.suggestions.slice(0, SearchState.config.maxSuggestions).forEach((suggestion) => {
        const item = this.createSuggestionItem(suggestion, itemIndex);
        fragment.appendChild(item);
        itemIndex++;
      });
    }
    if (SearchState.config.showProducts && results.products && results.products.length > 0) {
      const productsHeader = $.el("div", "afs-search-dropdown__header");
      productsHeader.textContent = `Products (${((_a = results.pagination) == null ? void 0 : _a.total) || results.products.length})`;
      fragment.appendChild(productsHeader);
      results.products.slice(0, SearchState.config.maxProducts).forEach((product) => {
        const item = this.createProductItem(product, itemIndex);
        fragment.appendChild(item);
        itemIndex++;
      });
      if (results.pagination && results.pagination.total > SearchState.config.maxProducts) {
        const viewAll = $.el("a", "afs-search-dropdown__view-all", {
          "href": `/search?q=${encodeURIComponent(query)}`,
          "role": "option"
        });
        viewAll.textContent = `View all ${results.pagination.total} results`;
        viewAll.setAttribute("data-index", String(itemIndex));
        fragment.appendChild(viewAll);
        itemIndex++;
      }
    }
    if (results.zeroResults && (!results.suggestions || results.suggestions.length === 0) && (!results.products || results.products.length === 0)) {
      fragment.appendChild(this.createEmptyState("No products found. Try adjusting your search terms."));
    }
    SearchState.dropdown.appendChild(fragment);
  },
  positionDropdown(input) {
    if (!SearchState.dropdown || !SearchState.container) return;
    this.updateContainerPosition(input, SearchState.container);
    SearchState.dropdown.style.position = "absolute";
    SearchState.dropdown.style.top = "100%";
    SearchState.dropdown.style.left = "0";
    SearchState.dropdown.style.width = "100%";
    SearchState.dropdown.style.maxHeight = "400px";
    SearchState.dropdown.style.overflowY = "auto";
    SearchState.dropdown.style.zIndex = "999999";
    SearchState.dropdown.style.marginTop = "4px";
  },
  showDropdown() {
    if (!SearchState.dropdown || !SearchState.activeInput) return;
    if (!SearchState.container) {
      SearchState.container = this.setupInputContainer(SearchState.activeInput);
      SearchState.dropdown = SearchState.container.querySelector(".afs-search-dropdown");
      if (!SearchState.dropdown) {
        SearchState.dropdown = this.createDropdown();
        SearchState.container.appendChild(SearchState.dropdown);
      }
    }
    SearchState.isOpen = true;
    SearchState.dropdown.classList.add("afs-search-dropdown--visible");
    SearchState.dropdown.setAttribute("aria-expanded", "true");
    this.positionDropdown(SearchState.activeInput);
  },
  hideDropdown() {
    if (!SearchState.dropdown) return;
    SearchState.isOpen = false;
    SearchState.selectedIndex = -1;
    SearchState.dropdown.classList.remove("afs-search-dropdown--visible");
    SearchState.dropdown.setAttribute("aria-expanded", "false");
  },
  highlightItem(index) {
    if (!SearchState.dropdown) return;
    const items = SearchState.dropdown.querySelectorAll('[role="option"][data-index]');
    items.forEach((item, i) => {
      if (i === index) {
        item.classList.add("afs-search-dropdown__item--selected");
        item.scrollIntoView({ block: "nearest", behavior: "smooth" });
      } else {
        item.classList.remove("afs-search-dropdown__item--selected");
      }
    });
    SearchState.selectedIndex = index;
  },
  getSelectedItem() {
    if (!SearchState.dropdown || SearchState.selectedIndex < 0) return null;
    const items = SearchState.dropdown.querySelectorAll('[role="option"][data-index]');
    return items[SearchState.selectedIndex] || null;
  }
};
var SearchAPI = {
  async search(query) {
    let shop = SearchState.config.shop;
    let apiBaseUrl = SearchState.config.apiBaseUrl;
    if (!shop || !apiBaseUrl) {
      Log.error("Search API: shop or apiBaseUrl not configured", {
        hasShop: !!shop,
        hasApiBaseUrl: !!apiBaseUrl
      });
      return null;
    }
    if (SearchState.abortController) {
      SearchState.abortController.abort();
    }
    SearchState.abortController = new AbortController();
    const params = new URLSearchParams();
    params.set("shop", shop);
    params.set("q", query);
    params.set("suggestions", "true");
    params.set("autocomplete", "true");
    params.set("limit", String(SearchState.config.maxProducts));
    const url = `${apiBaseUrl}/search?${params}`;
    try {
      SearchState.isLoading = true;
      SearchDOM.renderDropdown(null, query);
      const response = await fetch(url, {
        signal: SearchState.abortController.signal,
        headers: {
          "Accept": "application/json"
        }
      });
      if (!response.ok) {
        throw new Error(`HTTP ${response.status}: ${response.statusText}`);
      }
      const data = await response.json();
      if (!data.success || !data.data) {
        Log.error("Invalid search response", { data });
        return null;
      }
      return data.data;
    } catch (error) {
      if (error.name === "AbortError") {
        Log.debug("Search request aborted");
        return null;
      }
      Log.error("Search API error", { error: error.message, query });
      return null;
    } finally {
      SearchState.isLoading = false;
    }
  }
};
var SearchLogic = {
  debouncedSearch: $.debounce(async (query) => {
    if (query.length < SearchState.config.minQueryLength) {
      SearchState.searchResults = null;
      SearchDOM.hideDropdown();
      return;
    }
    if (SearchState.activeInput && !SearchState.inputContainers.has(SearchState.activeInput)) {
      SearchInit.replaceInput(SearchState.activeInput);
    }
    SearchState.currentQuery = query;
    const results = await SearchAPI.search(query);
    SearchState.searchResults = results;
    if (results !== null) {
      SearchDOM.renderDropdown(results, query);
      SearchDOM.showDropdown();
    } else {
      SearchDOM.hideDropdown();
    }
  }, DEFAULT_CONFIG.debounceMs),
  handleInput(e) {
    const input = e.target;
    const query = input.value.trim();
    SearchState.activeInput = input;
    SearchLogic.debouncedSearch(query);
  },
  handleFocus(e) {
    const input = e.target;
    SearchState.activeInput = input;
    if (!SearchState.inputContainers.has(input)) {
      SearchInit.replaceInput(input);
    } else {
      SearchState.container = SearchState.inputContainers.get(input);
      SearchState.dropdown = SearchState.container.querySelector(".afs-search-dropdown");
    }
    const query = input.value.trim();
    if (query.length >= SearchState.config.minQueryLength && SearchState.searchResults) {
      SearchDOM.renderDropdown(SearchState.searchResults, query);
      SearchDOM.showDropdown();
    } else if (query.length > 0) {
      SearchLogic.debouncedSearch(query);
    } else {
      SearchDOM.renderDropdown(null, "", true);
      SearchDOM.showDropdown();
    }
  },
  handleBlur(e) {
    setTimeout(() => {
      var _a, _b;
      if (!((_a = SearchState.dropdown) == null ? void 0 : _a.matches(":hover")) && !((_b = SearchState.activeInput) == null ? void 0 : _b.matches(":focus"))) {
        SearchDOM.hideDropdown();
      }
    }, 200);
  },
  handleKeyDown(e) {
    var _a, _b, _c, _d;
    if (!SearchState.isOpen || !SearchState.dropdown) return;
    const items = SearchState.dropdown.querySelectorAll('[role="option"][data-index]');
    const itemCount = items.length;
    switch (e.key) {
      case "ArrowDown":
        e.preventDefault();
        SearchState.selectedIndex = Math.min(SearchState.selectedIndex + 1, itemCount - 1);
        SearchDOM.highlightItem(SearchState.selectedIndex);
        break;
      case "ArrowUp":
        e.preventDefault();
        SearchState.selectedIndex = Math.max(SearchState.selectedIndex - 1, -1);
        if (SearchState.selectedIndex >= 0) {
          SearchDOM.highlightItem(SearchState.selectedIndex);
        } else {
          (_a = SearchState.activeInput) == null ? void 0 : _a.focus();
        }
        break;
      case "Enter":
        e.preventDefault();
        const selected = SearchDOM.getSelectedItem();
        if (selected) {
          if (selected.tagName === "A") {
            window.location.href = selected.href;
          } else if (selected.getAttribute("data-type") === "did-you-mean") {
            const didYouMean = (_b = SearchState.searchResults) == null ? void 0 : _b.didYouMean;
            if (didYouMean && SearchState.activeInput) {
              SearchState.activeInput.value = didYouMean;
              SearchLogic.debouncedSearch(didYouMean);
            }
          } else {
            const suggestion = (_c = selected.querySelector(".afs-search-dropdown__suggestion-text")) == null ? void 0 : _c.textContent;
            if (suggestion && SearchState.activeInput) {
              SearchState.activeInput.value = suggestion;
              SearchLogic.debouncedSearch(suggestion);
            }
          }
        } else if (SearchState.activeInput) {
          const query = SearchState.activeInput.value.trim();
          if (query) {
            window.location.href = `/search?q=${encodeURIComponent(query)}`;
          }
        }
        break;
      case "Escape":
        e.preventDefault();
        SearchDOM.hideDropdown();
        (_d = SearchState.activeInput) == null ? void 0 : _d.blur();
        break;
    }
  },
  handleClick(e) {
    var _a, _b;
    const target = e.target;
    const item = target.closest('[role="option"]');
    if (!item) return;
    if (item.tagName === "A") {
      const handle = item.getAttribute("data-handle");
      if (handle) {
        SearchDOM.hideDropdown();
        if (SearchState.customSearchBox) {
          SearchInit.hideCustomSearchBox();
        }
        return;
      } else {
        e.preventDefault();
        Log.warn("Product link clicked but no handle available");
        return;
      }
    }
    e.preventDefault();
    if (item.getAttribute("data-type") === "did-you-mean") {
      const didYouMean = (_a = SearchState.searchResults) == null ? void 0 : _a.didYouMean;
      if (didYouMean && SearchState.activeInput) {
        SearchState.activeInput.value = didYouMean;
        SearchLogic.debouncedSearch(didYouMean);
      }
    } else {
      const suggestion = (_b = item.querySelector(".afs-search-dropdown__suggestion-text")) == null ? void 0 : _b.textContent;
      if (suggestion && SearchState.activeInput) {
        SearchState.activeInput.value = suggestion;
        SearchLogic.debouncedSearch(suggestion);
      }
    }
  }
};
var SearchInit = {
  /**
   * Read config from data attributes on container element
   */
  readConfigFromDataAttributes() {
    const container = document.querySelector("[data-afs-search-container]");
    if (!container) {
      return null;
    }
    const config = {};
    if (container.dataset.afsSearchShop) {
      config.shop = container.dataset.afsSearchShop;
    }
    if (container.dataset.afsSearchApiBaseUrl) {
      config.apiBaseUrl = container.dataset.afsSearchApiBaseUrl;
    }
    if (container.dataset.afsSearchMoneyFormat) {
      config.moneyFormat = container.dataset.afsSearchMoneyFormat;
    }
    if (container.dataset.afsSearchCurrency) {
      config.currency = container.dataset.afsSearchCurrency;
    }
    if (container.dataset.afsSearchMoneyWithCurrencyFormat) {
      config.moneyWithCurrencyFormat = container.dataset.afsSearchMoneyWithCurrencyFormat;
    }
    if (container.dataset.afsSearchDebug !== void 0) {
      const value = container.dataset.afsSearchDebug;
      config.debug = value === "true" || value === "1" || value === true;
    }
    if (container.dataset.afsSearchMinQueryLength) {
      const minQueryLength = parseInt(container.dataset.afsSearchMinQueryLength, 10);
      if (!isNaN(minQueryLength) && minQueryLength > 0) {
        config.minQueryLength = minQueryLength;
      }
    }
    if (container.dataset.afsSearchDebounceMs) {
      const debounceMs = parseInt(container.dataset.afsSearchDebounceMs, 10);
      if (!isNaN(debounceMs) && debounceMs >= 0) {
        config.debounceMs = debounceMs;
      }
    }
    if (container.dataset.afsSearchMaxSuggestions) {
      const maxSuggestions = parseInt(container.dataset.afsSearchMaxSuggestions, 10);
      if (!isNaN(maxSuggestions) && maxSuggestions > 0) {
        config.maxSuggestions = maxSuggestions;
      }
    }
    if (container.dataset.afsSearchMaxProducts) {
      const maxProducts = parseInt(container.dataset.afsSearchMaxProducts, 10);
      if (!isNaN(maxProducts) && maxProducts > 0) {
        config.maxProducts = maxProducts;
      }
    }
    if (container.dataset.afsSearchShowSuggestions !== void 0) {
      const value = container.dataset.afsSearchShowSuggestions;
      config.showSuggestions = value === "true" || value === "1" || value === true;
    }
    if (container.dataset.afsSearchShowProducts !== void 0) {
      const value = container.dataset.afsSearchShowProducts;
      config.showProducts = value === "true" || value === "1" || value === true;
    }
    if (container.dataset.afsSearchEnableKeyboardNav !== void 0) {
      const value = container.dataset.afsSearchEnableKeyboardNav;
      config.enableKeyboardNav = value === "true" || value === "1" || value === true;
    }
    if (container.dataset.afsSearchInputSelector) {
      config.searchInputSelector = container.dataset.afsSearchInputSelector;
    }
    return Object.keys(config).length > 0 ? config : null;
  },
  /**
   * Create custom search box that will override theme's search
   */
  createCustomSearchBox() {
    if (SearchState.customSearchBox) {
      return SearchState.customSearchBox;
    }
    const searchBox = $.el("div", "afs-search-override-box");
    searchBox.style.cssText = `
			position: fixed;
			top: 0;
			left: 0;
			right: 0;
			background: var(--afs-bg-color, #fff);
			border-bottom: 1px solid var(--afs-border-color, #e0e0e0);
			z-index: 999998;
			padding: 16px;
			box-shadow: 0 2px 8px rgba(0,0,0,0.1);
			display: none;
		`;
    const searchForm = $.el("form", "afs-search-override-form");
    searchForm.style.cssText = `
			display: flex;
			align-items: center;
			gap: 12px;
			max-width: 1200px;
			margin: 0 auto;
		`;
    const searchInput = $.el("input", "afs-search-override-input");
    searchInput.type = "search";
    searchInput.name = "q";
    searchInput.placeholder = "Search products...";
    searchInput.autocomplete = "off";
    searchInput.style.cssText = `
			flex: 1;
			padding: 12px 16px;
			border: 1px solid var(--afs-border-color, #e0e0e0);
			border-radius: 4px;
			font-size: 16px;
			outline: none;
		`;
    const closeButton = $.el("button", "afs-search-override-close");
    closeButton.type = "button";
    closeButton.innerHTML = "\u2715";
    closeButton.setAttribute("aria-label", "Close search");
    closeButton.style.cssText = `
			padding: 8px 16px;
			background: transparent;
			border: none;
			font-size: 24px;
			cursor: pointer;
			color: var(--afs-text-color, #333);
		`;
    closeButton.addEventListener("click", () => {
      this.hideCustomSearchBox();
    });
    searchForm.appendChild(searchInput);
    searchForm.appendChild(closeButton);
    searchBox.appendChild(searchForm);
    document.body.appendChild(searchBox);
    this.replaceInput(searchInput);
    SearchState.customSearchBox = searchBox;
    return searchBox;
  },
  showCustomSearchBox() {
    const searchBox = this.createCustomSearchBox();
    searchBox.style.display = "block";
    const input = searchBox.querySelector("input");
    if (input) {
      setTimeout(() => input.focus(), 100);
    }
    document.body.style.overflow = "hidden";
  },
  hideCustomSearchBox() {
    if (SearchState.customSearchBox) {
      SearchState.customSearchBox.style.display = "none";
      SearchDOM.hideDropdown();
    }
    document.body.style.overflow = "";
  },
  /**
   * Find search icon buttons (common theme patterns)
   */
  findSearchButtons() {
    const selectors = [
      'button[aria-label*="search" i]',
      'button[aria-label*="Search" i]',
      'a[aria-label*="search" i]',
      'a[aria-label*="Search" i]',
      "button.search",
      "a.search",
      'button[class*="search"]',
      'a[class*="search"]',
      "button[data-search]",
      "a[data-search]",
      "[data-search-toggle]",
      "[data-search-trigger]",
      ".search-icon",
      ".search-button",
      '[id*="search" i]',
      '[class*="search-icon" i]',
      '[class*="search-button" i]',
      // Shopify common patterns
      'header button[type="button"]:has(svg[class*="search"])',
      'header a:has(svg[class*="search"])',
      ".header__icon--search",
      ".site-header__search"
    ];
    const buttons = [];
    selectors.forEach((selector) => {
      try {
        const elements = document.querySelectorAll(selector);
        elements.forEach((el) => {
          var _a, _b;
          const text = ((_a = el.textContent) == null ? void 0 : _a.toLowerCase()) || "";
          const ariaLabel = ((_b = el.getAttribute("aria-label")) == null ? void 0 : _b.toLowerCase()) || "";
          const hasSearchIcon = el.querySelector('svg[class*="search"], svg[aria-label*="search" i]');
          if (hasSearchIcon || text.includes("search") || ariaLabel.includes("search")) {
            buttons.push(el);
          }
        });
      } catch (e) {
      }
    });
    return buttons;
  },
  /**
   * Find predictive search containers (common theme patterns)
   */
  findPredictiveSearchContainers() {
    const selectors = [
      "[data-predictive-search]",
      '[id*="predictive" i]',
      '[class*="predictive" i]',
      '[class*="search-results" i]',
      '[class*="search-dropdown" i]',
      '[class*="search-suggestions" i]',
      ".predictive-search",
      ".search-results",
      ".search-dropdown",
      ".search-suggestions",
      "[data-search-results]",
      "[data-search-dropdown]",
      // Shopify common patterns
      '[id*="Search" i]',
      '[class*="Search" i]'
    ];
    const containers = [];
    selectors.forEach((selector) => {
      try {
        const elements = document.querySelectorAll(selector);
        elements.forEach((el) => {
          if (!el.classList.contains("afs-search-container") && !el.classList.contains("afs-search-dropdown")) {
            containers.push(el);
          }
        });
      } catch (e) {
      }
    });
    return containers;
  },
  /**
   * Override search button click to show our custom search
   */
  overrideSearchButton(button) {
    if (SearchState.searchButtons.has(button)) return;
    button.addEventListener("click", (e) => {
      e.preventDefault();
      e.stopPropagation();
      e.stopImmediatePropagation();
      this.hideThemeSearchContainers();
      this.showCustomSearchBox();
    }, true);
    SearchState.searchButtons.add(button);
    Log.debug("Overridden search button", { button });
  },
  /**
   * Hide theme's native search containers
   */
  hideThemeSearchContainers() {
    const containers = this.findPredictiveSearchContainers();
    containers.forEach((container) => {
      container.style.display = "none";
      container.setAttribute("data-afs-hidden", "true");
      SearchState.overriddenContainers.add(container);
    });
  },
  /**
   * Override search containers by replacing their content
   */
  overrideSearchContainers() {
    const containers = this.findPredictiveSearchContainers();
    containers.forEach((container) => {
      if (SearchState.overriddenContainers.has(container)) return;
      container.style.display = "none";
      container.setAttribute("data-afs-hidden", "true");
      SearchState.overriddenContainers.add(container);
      Log.debug("Overridden search container", { container });
    });
  },
  replaceInput(input) {
    if (SearchState.replacedInputs.has(input)) return;
    const container = SearchDOM.setupInputContainer(input);
    SearchState.container = container;
    let dropdown = container.querySelector(".afs-search-dropdown");
    if (!dropdown) {
      dropdown = SearchDOM.createDropdown();
      container.appendChild(dropdown);
    }
    SearchState.dropdown = dropdown;
    dropdown.addEventListener("click", SearchLogic.handleClick);
    const form = input.closest("form");
    if (form) {
      form.addEventListener("submit", (e) => {
        e.preventDefault();
        const query = input.value.trim();
        if (query) {
          window.location.href = `/search?q=${encodeURIComponent(query)}`;
        }
      });
    }
    input.addEventListener("input", SearchLogic.handleInput);
    input.addEventListener("focus", SearchLogic.handleFocus);
    input.addEventListener("blur", SearchLogic.handleBlur);
    input.addEventListener("keydown", SearchLogic.handleKeyDown);
    input.setAttribute("data-afs-search", "true");
    SearchState.replacedInputs.add(input);
  },
  isFilterSectionInput(input) {
    if (input.classList.contains("afs-filter-group__search-input")) {
      return true;
    }
    const filterContainer = input.closest("[data-afs-container]");
    if (filterContainer) {
      return true;
    }
    const filterGroup = input.closest(".afs-filter-group");
    if (filterGroup) {
      return true;
    }
    if (input.name && input.name.startsWith("afs-search-")) {
      return true;
    }
    return false;
  },
  isShopifySearchInput(input) {
    if (input.name === "q") {
      return true;
    }
    if (input.name === "search") {
      return true;
    }
    const form = input.closest("form");
    if (form) {
      const action = form.getAttribute("action");
      if (action && (action.includes("/search") || action.includes("search"))) {
        if (input.type === "search" || input.type === "text" || !input.type) {
          return true;
        }
      }
    }
    if (input.classList.contains("search__input")) {
      return true;
    }
    if (input.hasAttribute("data-search-input")) {
      return true;
    }
    return false;
  },
  overrideSearchButtons() {
    const buttons = this.findSearchButtons();
    buttons.forEach((button) => {
      this.overrideSearchButton(button);
    });
  },
  findAndReplaceInputs() {
    const inputs = document.querySelectorAll(SearchState.config.searchInputSelector);
    inputs.forEach((input) => {
      if (SearchState.replacedInputs.has(input)) {
        return;
      }
      if (this.isFilterSectionInput(input)) {
        Log.debug("Skipping filter section input", { name: input.name, class: input.className });
        return;
      }
      if (this.isShopifySearchInput(input)) {
        Log.debug("Processing Shopify search input", { name: input.name, type: input.type });
        this.replaceInput(input);
      }
    });
  },
  init(config) {
    let finalConfig = {};
    const dataConfig = this.readConfigFromDataAttributes();
    if (dataConfig) {
      finalConfig = { ...finalConfig, ...dataConfig };
    }
    if (config && Object.keys(config).length > 0) {
      finalConfig = { ...finalConfig, ...config };
    }
    SearchState.config = { ...DEFAULT_CONFIG, ...finalConfig };
    this.overrideSearchButtons();
    this.overrideSearchContainers();
    this.findAndReplaceInputs();
    const observer = new MutationObserver(() => {
      this.overrideSearchButtons();
      this.overrideSearchContainers();
      this.findAndReplaceInputs();
    });
    observer.observe(document.body, {
      childList: true,
      subtree: true
    });
    document.addEventListener("click", (e) => {
      var _a;
      if (SearchState.isOpen && SearchState.container) {
        const target = e.target;
        if (!SearchState.container.contains(target) && !((_a = SearchState.activeInput) == null ? void 0 : _a.contains(target))) {
          SearchDOM.hideDropdown();
        }
      }
      if (SearchState.customSearchBox && SearchState.customSearchBox.style.display === "block") {
        const target = e.target;
        if (!SearchState.customSearchBox.contains(target)) {
          const clickedButton = target.closest("button, a");
          if (!clickedButton || !SearchState.searchButtons.has(clickedButton)) {
            this.hideCustomSearchBox();
          }
        }
      }
    });
    document.addEventListener("keydown", (e) => {
      if (e.key === "Escape" && SearchState.customSearchBox && SearchState.customSearchBox.style.display === "block") {
        this.hideCustomSearchBox();
      }
    });
    let resizeTimer;
    const updatePosition = () => {
      if (SearchState.activeInput && SearchState.container) {
        SearchDOM.updateContainerPosition(SearchState.activeInput, SearchState.container);
        if (SearchState.isOpen) {
          SearchDOM.positionDropdown(SearchState.activeInput);
        }
      }
    };
    window.addEventListener("scroll", () => {
      clearTimeout(resizeTimer);
      resizeTimer = setTimeout(updatePosition, 10);
    }, true);
    window.addEventListener("resize", () => {
      clearTimeout(resizeTimer);
      resizeTimer = setTimeout(updatePosition, 10);
    });
    Log.info("Search module initialized", { config: SearchState.config });
  }
};
if (typeof window !== "undefined") {
  const win = window;
  win.AFSSearch = {
    init: SearchInit.init.bind(SearchInit)
  };
}
var autoInit = () => {
  const container = document.querySelector("[data-afs-search-container]");
  if (container) {
    SearchInit.init();
  }
};
if (document.readyState === "loading") {
  document.addEventListener("DOMContentLoaded", autoInit);
} else {
  setTimeout(autoInit, 50);
}
